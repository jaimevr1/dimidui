# Story 3.2: Sistema de Desbloqueio de Atividades

- **Status**: Draft
- **Epic**: 3
- **Release**: 1.0

## Story
As a: Aluno,
I want: Desbloquear novas atividades ao completar as anteriores com sucesso,
so that: Eu sinta que estou progredindo em uma jornada.

## Acceptance Criteria
1.  A função `getAvailableActivities` deve ser implementada conforme a especificação.
2.  No dashboard do aluno, atividades bloqueadas devem ser visualmente distintas (ex: cinza, com um ícone de cadeado).
3.  Uma atividade com um `unlocked_by` preenchido só deve ficar disponível se o aluno tiver completado a atividade pré-requisito com acurácia de 70% ou mais.

## Dev Notes

### Lógica de Desbloqueio
A lógica central está na função `getAvailableActivities`, detalhada na especificação técnica. Ela envolve múltiplas chamadas ao Supabase para cruzar informações de atividades atribuídas, atividades concluídas e a relação de desbloqueio entre elas.

- **Fonte**: `docs/dimidui_spec.md#7-lógica-de-desbloqueio`

### Consultas ao Banco de Dados
Será necessário realizar as seguintes consultas em sequência:
1.  Buscar as atividades atribuídas (`activity_assignments`).
2.  Buscar as atividades concluídas com sucesso (`student_attempts` com `accuracy >= 0.70`).
3.  Buscar os detalhes de todas as atividades atribuídas (`activities`).
4.  Filtrar a lista final em JavaScript, comparando o campo `unlocked_by` de cada atividade com a lista de atividades concluídas com sucesso.

- **Fonte**: `docs/architecture/5-database-schema.md`

### Interface do Usuário
A mudança na UI será no dashboard do aluno. Os cards de atividade precisarão de um estado "bloqueado". Isso pode ser controlado adicionando uma classe CSS ao card, que o deixará com uma aparência diferente (ex: `filter: grayscale(1);`) e talvez desabilitará o link.

- **Fonte**: `docs/prd/user-interface-design-goals.md`

## Tasks / Subtasks

1.  **Implementar a Função `getAvailableActivities` (AC: 1, 3)**
    - [ ] Modifique o script `/scripts/dashboard.js`.
    - [ ] Crie uma função assíncrona `getAvailableActivities(studentId)` que segue a lógica da especificação.
    - [ ] **Passo 1**: Busque em `activity_assignments` os `activity_id`s para o `studentId`.
    - [ ] **Passo 2**: Busque em `student_attempts` todas as tentativas concluídas para o `studentId` e filtre aquelas com `accuracy >= 0.70`, criando uma lista de IDs de atividades concluídas com sucesso.
    - [ ] **Passo 3**: Busque os detalhes de todas as atividades atribuídas na tabela `activities`.
    - [ ] **Passo 4**: Filtre a lista de atividades em JavaScript. Uma atividade passa no filtro se `activity.unlocked_by` for nulo OU se `activity.unlocked_by` estiver presente na lista de IDs de atividades concluídas com sucesso.
    - [ ] A função deve retornar a lista de atividades filtrada (disponíveis).

2.  **Atualizar a Renderização do Dashboard (AC: 2)**
    - [ ] Modifique a função que renderiza os cards de atividade no `dashboard.js`.
    - [ ] Em vez de buscar todas as atividades atribuídas diretamente, chame a nova função `getAvailableActivities` para obter a lista de atividades disponíveis.
    - [ ] Para renderizar também as bloqueadas, a `getAvailableActivities` pode ser modificada para retornar um objeto `{ available: [...], locked: [...] }`.
    - [ ] Ao renderizar um card para uma atividade bloqueada, adicione uma classe CSS (ex: `.locked`) a ele.
    - [ ] Defina o estilo para a classe `.locked` em `styles/global.css` (ex: `opacity: 0.5; pointer-events: none;`). Adicione um ícone de cadeado ao card.

3.  **Verificação Manual**
    - [ ] No Supabase, crie duas atividades: Atividade A (sem `unlocked_by`) e Atividade B (com `unlocked_by` apontando para o ID da Atividade A).
    - [ ] Atribua ambas as atividades a um aluno de teste.
    - [ ] Faça login como o aluno. Verifique se a Atividade A está disponível e a Atividade B está bloqueada/cinza.
    - [ ] Complete a Atividade A com uma acurácia menor que 70%. Volte ao dashboard e verifique se a Atividade B continua bloqueada.
    - [ ] Complete a Atividade A novamente, desta vez com acurácia de 70% ou mais.
    - [ ] Volte ao dashboard e verifique se a Atividade B agora está desbloqueada e disponível.
